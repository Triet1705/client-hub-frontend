#!/bin/bash
#
# ============================================================================
# PRE-COMMIT HOOK - SECRET SCANNING (Client Hub Frontend)
# ============================================================================
# Purpose: Prevent committing sensitive files and secrets
# Tech Stack: Next.js + React + Web3 (RainbowKit + Wagmi)
# ============================================================================

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' 

echo -e "${YELLOW}[Security] ğŸ›¡ï¸  Scanning staged files for secrets...${NC}"

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ… No files staged for commit${NC}"
    exit 0
fi

FORBIDDEN=0
WARNING=0

# ============================================================================
# SECTION 1: FILE EXTENSION BLOCKING (CRITICAL - HARD BLOCK)
# ============================================================================
echo -e "${YELLOW}ğŸ“ Checking file extensions...${NC}"

SENSITIVE_EXTENSIONS='(\.env$|\.env\.local$|\.env\.development$|\.env\.production$|\.env\.staging$|\.key$|\.pem$|\.p12$|\.pfx$|\.secret$)'

for file in $STAGED_FILES; do
    if [[ "$file" == *".githooks/"* ]] || [[ "$file" == *"package-lock.json"* ]] || [[ "$file" == *"yarn.lock"* ]]; then
        continue
    fi
    
    if [[ "$file" == *".env.example"* ]] || [[ "$file" == *".env.template"* ]]; then
        continue
    fi
    
    if echo "$file" | grep -qE "$SENSITIVE_EXTENSIONS"; then
        echo -e "${RED}[BLOCK] âŒ Forbidden file type: $file${NC}"
        echo -e "${RED}     â†’ This file type should NEVER be committed (contains secrets)${NC}"
        FORBIDDEN=1
    fi
done

# ============================================================================
# SECTION 2: SENSITIVE PATTERN SCANNING (WARNING + BLOCK)
# ============================================================================
echo -e "${YELLOW}ğŸ” Scanning file contents for sensitive patterns...${NC}"

PRIVATE_KEY_PATTERN='(0x[a-fA-F0-9]{64}|-----BEGIN (RSA |EC )?PRIVATE KEY-----)'
WALLET_CONNECT_PATTERN='(NEXT_PUBLIC_WALLET_CONNECT_PROJECT_ID\s*=\s*["\x27]?[a-f0-9]{32})'
API_KEY_PATTERN='(NEXT_PUBLIC_[A-Z_]*KEY\s*=\s*["\x27]?[a-zA-Z0-9_-]{20,})'
SECRET_PATTERN='(JWT_SECRET|SESSION_SECRET|ENCRYPTION_KEY|ADMIN_PASSWORD)\s*=\s*["\x27]?.{8,}'

for file in $STAGED_FILES; do
    if file "$file" | grep -q "text"; then
        if grep -qE "$PRIVATE_KEY_PATTERN" "$file" 2>/dev/null; then
            echo -e "${RED}[BLOCK] ğŸ” Private key detected in: $file${NC}"
            echo -e "${RED}     â†’ Remove private keys before committing!${NC}"
            FORBIDDEN=1
        fi

        if grep -qE "$WALLET_CONNECT_PATTERN" "$file" 2>/dev/null; then
            if [[ "$file" != *".env.example"* ]] && [[ "$file" != *".env.template"* ]]; then
                echo -e "${YELLOW}[WARNING] âš ï¸  WalletConnect Project ID found in: $file${NC}"
                echo -e "${YELLOW}     â†’ Make sure this is safe to commit (public ID vs secret)${NC}"
                WARNING=1
            fi
        fi

        if grep -qE "$API_KEY_PATTERN" "$file" 2>/dev/null; then
            if [[ "$file" != *".env.example"* ]] && [[ "$file" != *"README"* ]]; then
                echo -e "${YELLOW}[WARNING] âš ï¸  API key pattern found in: $file${NC}"
                WARNING=1
            fi
        fi

        if grep -qE "$SECRET_PATTERN" "$file" 2>/dev/null; then
            if [[ "$file" != *".env.example"* ]]; then
                echo -e "${RED}[BLOCK] ğŸ” Secret detected in: $file${NC}"
                FORBIDDEN=1
            fi
        fi
    fi
done

# ============================================================================
# SECTION 3: HARDCODED VALUES CHECK (WARNING)
# ============================================================================
echo -e "${YELLOW}ğŸ§ª Checking for hardcoded values...${NC}"

HARDCODED_PATTERNS='(http://localhost:8080|0x[a-fA-F0-9]{40}(?!.*example))'

for file in $STAGED_FILES; do
    if [[ "$file" =~ \.(ts|tsx|js|jsx)$ ]] && [[ "$file" != *"test"* ]]; then
        if grep -qE "$HARDCODED_PATTERNS" "$file" 2>/dev/null; then
            echo -e "${YELLOW}[WARNING] ğŸ’¡ Hardcoded value detected in: $file${NC}"
            echo -e "${YELLOW}     â†’ Consider using environment variables${NC}"
            WARNING=1
        fi
    fi
done

# ============================================================================
# SECTION 4: SUMMARY & EXIT
# ============================================================================
echo ""
if [ $FORBIDDEN -ne 0 ]; then
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}âŒ COMMIT BLOCKED - SECURITY ISSUES FOUND${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues above and try again.${NC}"
    echo ""
    echo -e "${YELLOW}Common fixes:${NC}"
    echo "  1. Remove secret files: git restore --staged <file>"
    echo "  2. Add to .gitignore if needed"
    echo "  3. Move secrets to .env.local (already in .gitignore)"
    echo ""
    exit 1
fi

if [ $WARNING -ne 0 ]; then
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${YELLOW}âš ï¸  WARNINGS FOUND (Commit will proceed)${NC}"
    echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}Review warnings above and ensure they're intentional.${NC}"
    echo ""
fi

echo -e "${GREEN}âœ… Security check passed${NC}"
exit 0
